---
title: "p8105_hw3_tq2171"
author: "Tingyu Qian"
date: "2024-10-9"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Problem 1
```{r}
# load the library and the dataset
library(p8105.datasets)
data("ny_noaa")
```

In the dataset "ny_noaa", it contains `r nrow(ny_noaa)` and `r ncol(ny_noaa)` columns, which means there are 7 variables. Name of the 7 variables are the following: `r names(ny_noaa)`.

The following are the variables introduction:

id: Weather station ID

date: Date of observation

prcp: Precipitation (tenths of mm)

snow: Snowfall (mm)

snwd: Snow depth (mm)

tmax: Maximum temperature (tenths of degrees C)

tmin: Minimum temperature (tenths of degrees C)

The type of each variable are the following: id is `r class(ny_noaa$id)`,  date is `r class(ny_noaa$date)`, prcp is `r class(ny_noaa$prcp)`, snow is `r class(ny_noaa$snow)`, snwd is `r class(ny_noaa$snwd)`, tmax is `r class(ny_noaa$tmax)`, tmin is `r class(ny_noaa$tmin)`. Variables "prcp", "snow", "snwd" are the integer variables. Variables "id", "tmax" and "tmin" are character variables. There are `r sum(is.na(ny_noaa$prcp))` or `r round((sum(is.na(ny_noaa$prcp))/2595176)*100, 2)`% missing value in the variable "prcp", `r sum(is.na(ny_noaa$snow))` or `r round((sum(is.na(ny_noaa$snow))/2595176)*100, 2)`% missing value in the variable "snow", `r sum(is.na(ny_noaa$snwd))` or `r round((sum(is.na(ny_noaa$snwd))/2595176)*100, 2)`% missing value in the variable "snwd", `r sum(is.na(ny_noaa$tmax))` or `r round((sum(is.na(ny_noaa$tmax))/2595176)*100, 2)`% missing value in the variable "tmax" and `r sum(is.na(ny_noaa$tmin))`  or `r round((sum(is.na(ny_noaa$tmin))/2595176)*100, 2)`% missing value in the variable "tmin". 

```{r,warning=FALSE, message=FALSE}
#load the needed library
library(lubridate)
```

```{r}
# Create separate variables for year, month, and day
ny_noaa$year <- year(ny_noaa$date)
ny_noaa$month <- month(ny_noaa$date)
ny_noaa$day <- day(ny_noaa$date)
```

```{r}
# Precipitation (prcp): Currently in tenths of mm, divide by 10 to convert to millimeters (mm).
ny_noaa$prcp_mm <- ny_noaa$prcp / 10

# Maximum temperature (tmax): In tenths of degrees Celsius, divide by 10 to convert to degrees Celsius.
ny_noaa$tmax <- as.numeric(ny_noaa$tmax)
ny_noaa$tmax_c <- ny_noaa$tmax / 10

#Minimum temperature (tmin): In tenths of degrees Celsius, divide by 10 to convert to degrees Celsius.
ny_noaa$tmin <- as.numeric(ny_noaa$tmin)
ny_noaa$tmin_c <- ny_noaa$tmin / 10
```

```{r}
#Identify the most commonly observed values in "snowfall"

# Count occurrences of each snowfall value
snowfall_counts <- table(ny_noaa$snow)
# Sort the counts in descending order to find the most common values
sorted_snowfall <- sort(snowfall_counts, decreasing = TRUE)
# Display the most common snowfall values
head(sorted_snowfall)
```

The high frequency of 0 snowfall values in the dataset, with over 2 million occurrences, likely reflects the fact that snowfall is not a daily event in many regions, especially outside of winter months. Other smaller values, like 25, 13, and 51 mm, represent light snowfalls, which occur less frequently but are still common in regions with occasional snow. The predominance of zero snowfall days is expected when considering regions that experience seasonal snow or generally warmer climates.

```{r}
# Load necessary libraries
library(dplyr)
library(ggplot2)
```

```{r}
# Filter for January (1) and July (7)
jan_july_data <- ny_noaa %>% 
  filter(month %in% c("1", "7")) %>%
  mutate(month_name = ifelse(month == "1", "January", "July"))
```


```{r}
# Group by station, year, and month, and calculate average max temperature (tmax) per station and month
avg_temp <- jan_july_data %>%
  group_by(id, year, month_name) %>%
  summarise(avg_tmax = mean(tmax_c, na.rm = TRUE))
```

```{r}
# Remove any missing values (if needed)
avg_temp <- avg_temp %>% filter(!is.na(avg_tmax))
# Create a two-panel plot
ggplot(avg_temp, aes(x = year, y = avg_tmax)) +
  geom_point(alpha=0.5) +
  facet_grid(~ month_name) +# Create two panels for January and July
  labs(title = "Average Max Temperature in January and July Across Years",
       x = "Year",
       y = "Average Max Temperature (°C)") +
  theme(legend.position = "bottom")
```

The plot shows clear seasonal differences between January and July temperatures. In January, there is an observable warming trend starting around 1990, with average maximum temperatures increasing over time, possibly suggesting the effects of climate change on winter temperatures. January temperatures often fall below 0°C, with some notable dips close to or below -10°C, indicating particularly cold years or regions. In contrast, July temperatures are more consistent, with average maximum temperatures generally between 25°C and 30°C, showing less variability than January.

There are also some outliers present in the data. In January, certain years show unusually low temperatures, which may represent colder than average years. In July, a few temperatures drop below 20°C, which is unusual for summer and could either reflect rare cooler summers or potential data errors. The overall trend suggests a warming pattern in January, while July temperatures appear more stable.

```{r}
# 1. tmax vs tmin plot (using density plot)
tmax_tmin_density_plot <- ggplot(ny_noaa) +
  geom_density(aes(x = tmax_c, fill = "tmax"), alpha = 0.5) +  # Density for tmax
  geom_density(aes(x = tmin_c, fill = "tmin"), alpha = 0.5) +  # Density for tmin
  scale_fill_manual(values = c("tmax" = "red", "tmin" = "blue")) +
  labs(title = "Density Plot of tmax and tmin",
       x = "Temperature (°C)",
       fill = "Variable") +
  theme_minimal()
```

```{r}
# 2. Snowfall distribution (snowfall > 0 and < 100) by year
snowfall_violin_plot <- ggplot(snow_filtered, aes(x = year, y = snow)) +
  geom_violin(aes(fill = year)) +  # Violin plot showing distribution by year
  labs(title = "Snowfall Values Distribution (0 < snow < 100) by Year",
       x = "Year",
       y = "Snowfall (mm)")

# Display violin plot
snowfall_violin_plot
```

# Problem 2
```{r, warning=FALSE, message=FALSE}
## read and clean the data
library(tidyverse) 
nhanes_accel = read_csv (file = "./nhanes_accel.csv", na = c("NA", ".")) #read the data
nhanes_covar = read_csv (file = "./nhanes_covar.csv", na = c("NA", "."), skip=4) #read the data
```

```{r}
# Rename columns in the covariates dataset and convert to appropriate types
nhanes_covar <- 
  nhanes_covar %>%
  mutate(
    sex = recode(sex, `1` = "male", `2` = "female"),
    education = recode(education, 
                       `1` = "Less than high school", 
                       `2` = "High school equivalent", 
                       `3` = "More than high school"),
    age = as.numeric(age),  # Ensure age is numeric
    BMI = as.numeric(BMI)   # Ensure BMI is numeric
  )
```

```{r}
# Merge the nhanes_accel dataset and nhanes_covar dataset by 'SEQN'
nhanes_merged <- nhanes_covar %>%
  inner_join(nhanes_accel, by = "SEQN")
```

```{r}
# Exclude participants under 21 years of age
nhanes_merged <- nhanes_merged %>%
  filter(age >= 21)
```

```{r}
# Remove rows with missing demographic data
nhanes_merged <- nhanes_merged %>%
  drop_na(sex, age, BMI, education)
```

```{r}
# Create a summary table of the number of men and women in each education category
gender_education_table <- nhanes_merged %>%
  group_by(education, sex) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  arrange(education, sex)
```

```{r}
# Display the summary table
print(gender_education_table)
```

```{r}
# Visualize the age distributions for men and women within each education category
ggplot(nhanes_merged, aes(x = age, fill = sex)) +
  geom_density(alpha = 0.5) +  # Density plot with transparency for overlapping areas
  facet_wrap(~ education) +  # Facet by education category
  labs(title = "Age Distributions by Sex and Education Category",
       x = "Age (years)",
       y = "Density",
       fill = "Sex") +
  theme_minimal()
```
The age distributions by sex across the three education categories reveal distinct patterns. In the "High School Equivalent", both men and women exhibit a fairly balanced distribution, with peaks around the 40 to 60-year range. There is some overlap between the distributions, but men slightly dominate in younger ages, while women are more represented at older ages. In the "Less than high school" category, the age distribution for women skews toward older ages, with a significant peak around the 70 to 80-year range, suggesting that this group has more older women.
For men, the distribution covers a wider age range, with peaks appearing in both middle-aged (40-50 years) and older (70-80 years) groups. In the "More than high school" category, the age distributions suggest that women are more concentrated in younger age ranges, with a noticeable peak around 20 to 40 years, while the distribution for men spans a broader range, with a slightly higher density in younger ages (30-50 years). This may suggest that more men pursued higher education at younger ages.

```{r}
# Sum total activity for each participant across all minute columns
nhanes_total_activity <- 
  nhanes_merged %>%
  rowwise() %>%
  mutate(total_activity = sum(c_across(starts_with("min")), na.rm = TRUE)) %>%
  ungroup()
```

```{r}
# Create the scatterplot of total activity vs. age, with separate panels for education
ggplot(nhanes_total_activity, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.6) +  # Scatterplot with transparency
  geom_smooth(method = "loess", se = FALSE) +  # Add smooth trend lines
  facet_wrap(~ education) +  # Separate panels for each education category
  labs(
    title = "Total Activity vs. Age by Sex and Education Level",
    x = "Age (years)",
    y = "Total Activity (MIMS)",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Adjust x-axis text
```

The plot shows the relationship between total activity (MIMS) and age, separated by education level and sex. Across all education categories, there is a noticeable decline in total activity with increasing age, although the trends differ slightly between men and women.

In the High School Equivalent category, both men and women exhibit a peak in activity around the 30 to 40-year range, followed by a steady decline, with men generally maintaining higher activity levels than women until the decline levels off around 60 to 70 years.

In the Less than High School category, there is a steeper decline in activity for both men and women as age increases. Women show higher activity levels compared to men in earlylife (20 to 40 years), but both sexes converge to lower levels as they approach older age (70+ years).

In the More than High School category, activity levels are more stable over time, with smaller declines compared to the other education levels. Men and women exhibit relatively similar activity levels in this group, suggesting that individuals with higher education may maintain more consistent activity levels throughout life.

```{r}
# Reshape the data to long format for plotting (gather all minute columns into one)
nhanes_long <- nhanes_merged %>%
  pivot_longer(
    cols = starts_with("min"), 
    names_to = "minute", 
    values_to = "activity"
  ) %>%
  mutate(
    minute = as.numeric(gsub("min", "", minute))  # Convert minute column to numeric
  )

# Create the three-panel plot
ggplot(nhanes_long, aes(x = minute, y = activity, color = sex)) +
  geom_smooth(se = FALSE) +  # Add smooth trend lines for activity throughout the day
  facet_wrap(~ education, ncol = 1) +  # Create separate panels for each education level
  labs(
    title = "24-Hour Activity Time Course by Education Level and Sex",
    x = "Minute of the Day",
    y = "Activity (MIMS)",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis text for readability
```

The 24-hour activity time course plot reveals clear daily activity patterns across different education levels, with some similarities and subtle differences between men and women. Across all three education levels—"High school equivalent," "Less than high school," and "More than high school"—activity levels increase steadily in the morning (around minute 500, corresponding to 8–9 AM), peak around midday and early afternoon, and decline in the evening. There are small differences between men and women, with women generally showing slightly higher activity levels throughout the day, especially in the "More than high school" category. This might reflect more structured or habitual physical activities among women with higher education. Meanwhile, the "Less than high school" group shows slightly more variability in activity levels during peak hours. Overall, the pattern is consistent: activity peaks around midday and declines steadily toward the evening, with education level appearing to influence the smoothness and consistency of daily activity patterns.










